<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gerunds and Infinitives Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .option-correct { background-color: #d1fae5 !important; border-color: #10b981 !important; }
    .option-incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
    .pulse-animation { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.04); } 100% { transform: scale(1); } }

    .progress-bar { height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background-color: #3b82f6; transition: width 0.3s ease; }

    .violation-warning { animation: shake 0.5s; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

    button, .tap {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    input { font-size: 16px; }

    .safe-bottom {
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-3 sm:p-4 flex items-center justify-center">

  <!-- Violation Modal -->
  <div id="violation-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2" id="violation-title">Screen Switch Detected</h3>
        <p class="text-gray-600 mb-4" id="violation-message">Please stay on this page during the test.</p>
        <div class="mb-4">
          <div class="inline-flex items-center bg-yellow-50 px-3 py-1 rounded-full">
            <i class="fas fa-shield-alt text-yellow-600 mr-2"></i>
            <span class="text-yellow-700 font-medium">Violations: <span id="violation-count">0</span>/3</span>
          </div>
        </div>
        <button id="close-violation-modal" class="tap bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl w-full">
          Acknowledge
        </button>
      </div>
    </div>
  </div>

  <!-- Instructions Modal -->
  <div id="instructions-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-5 sm:p-6">
      <div class="text-center mb-5">
        <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Test Instructions</h2>
        <div class="w-16 h-1 bg-blue-500 mx-auto"></div>
      </div>

      <div class="mb-5 bg-gray-50 border rounded-2xl p-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Student name (optional)</label>
        <input id="student-name" type="text"
               class="w-full border rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-300"
               placeholder="e.g., Azizbek" />
        <p class="text-xs text-gray-500 mt-2">This name will be included in the Telegram report.</p>
      </div>

      <div class="space-y-4 mb-5">
        <div class="flex items-start">
          <div class="flex-shrink-0 w-9 h-9 bg-blue-100 rounded-full flex items-center justify-center mr-3">
            <i class="fas fa-list-check text-blue-600"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800">Test Format</h3>
            <p class="text-gray-600">25 questions. Choose the correct option.</p>
          </div>
        </div>

        <div class="flex items-start">
          <div class="flex-shrink-0 w-9 h-9 bg-purple-100 rounded-full flex items-center justify-center mr-3">
            <i class="fas fa-star text-purple-600"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800">Scoring</h3>
            <p class="text-gray-600">Immediate feedback + final result.</p>
          </div>
        </div>

        <div class="flex items-start">
          <div class="flex-shrink-0 w-9 h-9 bg-red-100 rounded-full flex items-center justify-center mr-3">
            <i class="fas fa-ban text-red-600"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800">Switching Rule</h3>
            <p class="text-gray-600">Avoid leaving the test. Repeated switching can terminate the test.</p>
            <p class="text-xs text-gray-500 mt-1">
              On phones, we only count real page-hiding switches to reduce false warnings.
            </p>
          </div>
        </div>
      </div>

      <button id="start-test" class="tap bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-2xl w-full pulse-animation">
        Start Test <i class="fas fa-play ml-2"></i>
      </button>
    </div>
  </div>

  <!-- Main Test Container -->
  <div id="test-container" class="hidden bg-white rounded-2xl shadow-xl w-full max-w-4xl overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold leading-tight">Gerunds and Infinitives Test</h1>
          <div class="flex items-center mt-2 text-sm sm:text-base text-blue-50">
            <i class="fas fa-graduation-cap mr-2"></i>
            <span>English Grammar Assessment</span>
          </div>
          <div class="mt-2 text-sm text-blue-100">
            Student: <span id="student-name-display" class="font-semibold">—</span>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="text-center bg-blue-800/30 px-3 py-2 rounded-xl min-w-[110px]">
            <div class="text-xs">Score</div>
            <div class="text-lg font-extrabold" id="score">0/25</div>
          </div>
          <div class="text-center bg-blue-800/30 px-3 py-2 rounded-xl min-w-[110px]">
            <div class="text-xs">Progress</div>
            <div class="text-lg font-extrabold" id="progress">1/25</div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="flex justify-between text-xs sm:text-sm mb-1 text-blue-50">
          <span>Question <span id="current-question-num">1</span> of 25</span>
          <span id="progress-percent">4%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 4%"></div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="p-4 sm:p-6">
      <div id="question-container" class="mb-4"></div>
      <div id="feedback" class="mt-4 p-4 rounded-xl border hidden"></div>
      <div id="telegram-status" class="mt-4 hidden p-4 rounded-xl border"></div>

      <!-- Stats -->
      <div class="mt-5 p-4 bg-gray-50 rounded-2xl flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div class="flex items-center gap-5">
          <div class="flex items-center">
            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
            <span class="text-sm text-gray-700">Correct: <span id="correct-count">0</span></span>
          </div>
          <div class="flex items-center">
            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
            <span class="text-sm text-gray-700">Incorrect: <span id="incorrect-count">0</span></span>
          </div>
        </div>
        <div class="flex items-center">
          <i class="fas fa-eye-slash text-yellow-500 mr-2"></i>
          <span class="text-sm text-gray-700">Focus: <span id="focus-status" class="font-semibold">Good</span></span>
        </div>
      </div>
    </div>

    <!-- Sticky mobile navigation (NO HINT BUTTON) -->
    <div class="border-t bg-white/95 backdrop-blur sticky bottom-0 safe-bottom">
      <div class="p-3 sm:p-4 flex items-center justify-between gap-3">
        <button id="prev-btn" class="tap flex-1 bg-gray-200 hover:bg-gray-300 text-gray-900 font-bold px-4 py-3 rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <i class="fas fa-arrow-left mr-2"></i> Prev
        </button>

        <button id="next-btn" class="tap flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold px-4 py-3 rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed">
          Next <i class="fas fa-arrow-right ml-2"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ---------------- QUESTIONS ----------------
    const questions = [
      { question: "She agreed ___ us with the project.", options: ["to help", "helping"], answer: "to help", explanation: "\"Agree\" is followed by an infinitive (to + verb)." },
      { question: "I can’t afford ___ a new phone right now.", options: ["to buy", "buying"], answer: "to buy", explanation: "\"Afford\" is followed by an infinitive." },
      { question: "He avoided ___ eye contact during the interview.", options: ["to make", "making"], answer: "making", explanation: "\"Avoid\" is followed by a gerund (verb + -ing)." },
      { question: "They decided ___ early to catch the train.", options: ["to leave", "leaving"], answer: "to leave", explanation: "\"Decide\" is followed by an infinitive." },
      { question: "I suggest ___ the topic before the presentation.", options: ["to review", "reviewing"], answer: "reviewing", explanation: "\"Suggest\" is followed by a gerund." },
      { question: "We managed ___ all the tasks on time.", options: ["to complete", "completing"], answer: "to complete", explanation: "\"Manage\" is followed by an infinitive." },
      { question: "He denied ___ the vase.", options: ["to break", "breaking"], answer: "breaking", explanation: "\"Deny\" is followed by a gerund." },
      { question: "She promised ___ me with my homework.", options: ["to help", "helping"], answer: "to help", explanation: "\"Promise\" is followed by an infinitive." },
      { question: "They postponed ___ the meeting until next week.", options: ["to have", "having"], answer: "having", explanation: "\"Postpone\" is followed by a gerund." },
      { question: "I want ___ more about history.", options: ["to learn", "learning"], answer: "to learn", explanation: "\"Want\" is followed by an infinitive." },
      { question: "He refused ___ the form.", options: ["to sign", "signing"], answer: "to sign", explanation: "\"Refuse\" is followed by an infinitive." },
      { question: "I don’t mind ___ late sometimes.", options: ["to stay", "staying"], answer: "staying", explanation: "\"Mind\" is followed by a gerund." },
      { question: "She failed ___ the exam again.", options: ["to pass", "passing"], answer: "to pass", explanation: "\"Fail\" is followed by an infinitive." },
      { question: "He considered ___ a new job.", options: ["to find", "finding"], answer: "finding", explanation: "\"Consider\" is followed by a gerund." },
      { question: "We hope ___ you again soon.", options: ["to see", "seeing"], answer: "to see", explanation: "\"Hope\" is followed by an infinitive." },
      { question: "They arranged ___ at 9 a.m.", options: ["to meet", "meeting"], answer: "to meet", explanation: "\"Arrange\" is followed by an infinitive." },
      { question: "She risked ___ her passport.", options: ["to lose", "losing"], answer: "losing", explanation: "\"Risk\" is followed by a gerund." },
      { question: "I fancy ___ a trip to the mountains.", options: ["to take", "taking"], answer: "taking", explanation: "\"Fancy\" is followed by a gerund." },
      { question: "He offered ___ me to the airport.", options: ["to drive", "driving"], answer: "to drive", explanation: "\"Offer\" is followed by an infinitive." },
      { question: "I'm learning ___ French.", options: ["to speak", "speaking"], answer: "to speak", explanation: "\"Learn\" is followed by an infinitive." },
      { question: "I miss ___ time with my old friends.", options: ["to spend", "spending"], answer: "spending", explanation: "\"Miss\" is followed by a gerund." },
      { question: "He threatened ___ the police.", options: ["to call", "calling"], answer: "to call", explanation: "\"Threaten\" is followed by an infinitive." },
      { question: "She tends ___ nervous when speaking in public.", options: ["to get", "getting"], answer: "to get", explanation: "\"Tend\" is followed by an infinitive." },
      { question: "He imagined ___ in a castle.", options: ["to live", "living"], answer: "living", explanation: "\"Imagine\" is followed by a gerund." },
      { question: "Don't forget ___ your keys.", options: ["to take", "taking"], answer: "to take", explanation: "\"Forget\" + to-infinitive for future action." }
    ];

    // ---------------- STATE ----------------
    let currentQuestion = 0;
    let score = 0;
    let correctCount = 0;
    let incorrectCount = 0;
    let userAnswers = new Array(questions.length).fill(null);
    let violations = 0;
    let testStarted = false;
    let lastFocusTime = Date.now();
    let studentName = "";
    let testStartedAt = null;
    let testEndedAt = null;
    let resultsSent = false;

    const IS_MOBILE = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);

    // ---------------- DOM ----------------
    const questionContainer = document.getElementById("question-container");
    const feedback = document.getElementById("feedback");
    const telegramStatus = document.getElementById("telegram-status");
    const scoreDisplay = document.getElementById("score");
    const progressDisplay = document.getElementById("progress");
    const currentQuestionNum = document.getElementById("current-question-num");
    const progressPercent = document.getElementById("progress-percent");
    const progressFill = document.getElementById("progress-fill");
    const correctCountDisplay = document.getElementById("correct-count");
    const incorrectCountDisplay = document.getElementById("incorrect-count");
    const focusStatus = document.getElementById("focus-status");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const startBtn = document.getElementById("start-test");
    const testContainer = document.getElementById("test-container");
    const instructionsModal = document.getElementById("instructions-modal");
    const violationModal = document.getElementById("violation-modal");
    const violationTitle = document.getElementById("violation-title");
    const violationMessage = document.getElementById("violation-message");
    const violationCountDisplay = document.getElementById("violation-count");
    const closeViolationModal = document.getElementById("close-violation-modal");
    const studentNameInput = document.getElementById("student-name");
    const studentNameDisplay = document.getElementById("student-name-display");

    function initTest() {
      instructionsModal.classList.remove("hidden");
      testContainer.classList.add("hidden");
      updateScoreDisplay();
      updateProgressDisplay();
      updateStats();
      updateFocusStatus();
    }

    startBtn.addEventListener("click", () => {
      studentName = (studentNameInput.value || "").trim();
      studentNameDisplay.textContent = studentName ? studentName : "—";

      instructionsModal.classList.add("hidden");
      testContainer.classList.remove("hidden");

      testStarted = true;
      testStartedAt = new Date().toISOString();
      lastFocusTime = Date.now();

      startFocusMonitoring();
      renderQuestion();
    });

    function updateScoreDisplay() {
      scoreDisplay.textContent = `${score}/${questions.length}`;
    }

    function updateProgressDisplay() {
      const progress = currentQuestion + 1;
      const percent = Math.round((progress / questions.length) * 100);
      progressDisplay.textContent = `${progress}/${questions.length}`;
      currentQuestionNum.textContent = progress;
      progressPercent.textContent = `${percent}%`;
      progressFill.style.width = `${percent}%`;
    }

    function updateStats() {
      correctCountDisplay.textContent = correctCount;
      incorrectCountDisplay.textContent = incorrectCount;
    }

    function updateFocusStatus() {
      if (violations === 0) {
        focusStatus.textContent = "Good";
        focusStatus.className = "font-semibold text-green-600";
      } else if (violations === 1) {
        focusStatus.textContent = "Warning";
        focusStatus.className = "font-semibold text-yellow-600";
      } else if (violations === 2) {
        focusStatus.textContent = "Final Warning";
        focusStatus.className = "font-semibold text-orange-600";
      } else {
        focusStatus.textContent = "Violated";
        focusStatus.className = "font-semibold text-red-600";
      }
    }

    function renderQuestion() {
      const q = questions[currentQuestion];
      const answered = userAnswers[currentQuestion] !== null;

      let html = `
        <div class="mb-3">
          <div class="flex items-center mb-2">
            <div class="bg-blue-100 text-blue-800 font-extrabold rounded-full w-9 h-9 flex items-center justify-center mr-3">
              ${currentQuestion + 1}
            </div>
            <h2 class="text-lg sm:text-xl font-extrabold text-gray-800">Complete the Sentence</h2>
          </div>

          <div class="bg-blue-50 p-4 sm:p-5 rounded-2xl border border-blue-100">
            <p class="text-base sm:text-lg text-gray-900 leading-relaxed">${escapeHtml(q.question)}</p>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-3 mt-4" id="options-grid">
      `;

      q.options.forEach((option, index) => {
        const isCorrectAnswer = option === q.answer;
        const isUserAnswer = userAnswers[currentQuestion] === option;

        let cls = "tap w-full text-left p-4 rounded-2xl border-2 font-semibold flex items-center gap-3 transition active:scale-[0.99] ";
        let icon = "fas fa-circle text-gray-300";

        if (answered) {
          if (isCorrectAnswer) {
            cls += "option-correct border-green-400 ";
            icon = "fas fa-check-circle text-green-600";
          } else if (isUserAnswer && !isCorrectAnswer) {
            cls += "option-incorrect border-red-300 ";
            icon = "fas fa-times-circle text-red-600";
          } else {
            cls += "bg-gray-50 border-gray-200 opacity-90 ";
            icon = "far fa-circle text-gray-300";
          }
        } else {
          cls += "bg-white border-gray-300 hover:border-blue-400 hover:bg-blue-50 ";
        }

        html += `
          <button class="${cls}" data-option-index="${index}" ${answered ? "disabled" : ""}>
            <i class="${icon}"></i>
            <span class="text-base">${escapeHtml(option)}</span>
          </button>
        `;
      });

      html += `</div>`;

      if (answered) {
        html += `
          <div class="mt-4 p-4 bg-gray-50 rounded-2xl border">
            <div class="flex items-center mb-2">
              <i class="fas fa-info-circle text-blue-500 mr-2"></i>
              <h3 class="font-bold text-gray-800">Explanation</h3>
            </div>
            <p class="text-gray-700 leading-relaxed">${escapeHtml(q.explanation)}</p>
          </div>
        `;
      }

      questionContainer.innerHTML = html;

      document.querySelectorAll("#options-grid button").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.getAttribute("data-option-index"));
          selectOption(q.options[idx]);
        }, { passive: true });
      });

      prevBtn.disabled = currentQuestion === 0;
      nextBtn.textContent = currentQuestion === questions.length - 1 ? "Submit" : "Next";
      nextBtn.disabled = userAnswers[currentQuestion] === null;

      updateProgressDisplay();
    }

    function selectOption(option) {
      if (userAnswers[currentQuestion] !== null) return;

      userAnswers[currentQuestion] = option;
      const q = questions[currentQuestion];
      const isCorrect = option === q.answer;

      if (isCorrect) { score++; correctCount++; }
      else { incorrectCount++; }

      updateScoreDisplay();
      updateStats();

      renderQuestion();
      showFeedback(isCorrect, q.explanation);
    }

    function showFeedback(isCorrect, explanation) {
      feedback.classList.remove("hidden");

      if (isCorrect) {
        feedback.className = "mt-4 p-4 rounded-2xl border bg-green-50 border-green-200";
        feedback.innerHTML = `<div class="flex gap-3">
          <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-check text-green-600"></i>
          </div>
          <div>
            <h3 class="font-extrabold text-green-800">Correct!</h3>
            <p class="text-green-700">${escapeHtml(explanation)}</p>
          </div>
        </div>`;
      } else {
        feedback.className = "mt-4 p-4 rounded-2xl border bg-red-50 border-red-200";
        feedback.innerHTML = `<div class="flex gap-3">
          <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
            <i class="fas fa-times text-red-600"></i>
          </div>
          <div>
            <h3 class="font-extrabold text-red-800">Incorrect</h3>
            <p class="text-red-700">${escapeHtml(explanation)}</p>
          </div>
        </div>`;
      }
    }

    // Navigation
    prevBtn.addEventListener("click", () => {
      if (currentQuestion > 0) {
        currentQuestion--;
        renderQuestion();
        feedback.classList.add("hidden");
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        renderQuestion();
        feedback.classList.add("hidden");
      } else {
        endTest();
      }
    });

    function getPraiseMessage(score) {
      if (score >= 23) return "Outstanding! Perfect grasp of gerunds and infinitives!";
      if (score >= 20) return "Excellent! Strong understanding of the concepts.";
      if (score >= 17) return "Great job! You know most of these well.";
      if (score >= 14) return "Good work! You understand the basics well.";
      if (score >= 10) return "Not bad! Review the explanations to improve.";
      return "Keep practicing! Review gerunds and infinitives rules.";
    }

    async function endTest() {
      testEndedAt = new Date().toISOString();
      const percentage = Math.round((score / questions.length) * 100);
      const praise = getPraiseMessage(score);

      questionContainer.innerHTML = `
        <div class="text-center py-8">
          <div class="mb-6">
            <div class="w-20 h-20 mx-auto bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mb-4">
              <i class="fas fa-trophy text-white text-3xl"></i>
            </div>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Test Complete!</h2>
            <p class="text-gray-600">Finished successfully</p>
          </div>

          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl border border-blue-100 max-w-md mx-auto mb-6">
            <div class="text-5xl font-extrabold text-blue-600 mb-2">${percentage}%</div>
            <div class="text-xl font-bold text-gray-800 mb-1">${score}/${questions.length} Correct</div>
            <div class="text-lg text-blue-500 font-semibold mb-4">${escapeHtml(praise)}</div>
          </div>

          <div class="flex flex-col gap-3 max-w-md mx-auto">
            <button onclick="reviewTest()" class="tap bg-blue-500 hover:bg-blue-600 text-white font-bold px-6 py-3 rounded-2xl">
              <i class="fas fa-redo mr-2"></i> Review Answers
            </button>
            <button onclick="location.reload()" class="tap bg-gray-900 hover:bg-black text-white font-bold px-6 py-3 rounded-2xl">
              <i class="fas fa-sync-alt mr-2"></i> Restart
            </button>
          </div>
        </div>
      `;

      prevBtn.disabled = true;
      nextBtn.disabled = true;
      feedback.classList.add("hidden");
      stopFocusMonitoring();

      await sendResultsToTelegram({ terminated: false });
    }

    window.reviewTest = function() {
      currentQuestion = 0;
      prevBtn.disabled = false;
      nextBtn.disabled = false;
      resultsSent = false;
      renderQuestion();
    };

    // ---------- TELEGRAM ----------
    function buildTelegramMessage({ terminated }) {
      const percentage = Math.round((score / questions.length) * 100);
      const now = new Date().toISOString();
      const title = terminated ? "❌ TEST TERMINATED" : "✅ TEST SUBMITTED";

      let msg = "";
      msg += `<b>${title}</b>\n`;
      msg += `<b>Student:</b> ${escapeHtml(studentName || "Unknown")}\n`;
      msg += `<b>Score:</b> ${score}/${questions.length} (${percentage}%)\n`;
      msg += `<b>Correct:</b> ${correctCount} | <b>Incorrect:</b> ${incorrectCount}\n`;
      msg += `<b>Violations:</b> ${violations}\n`;
      msg += `<b>Started:</b> ${escapeHtml(testStartedAt || "-")}\n`;
      msg += `<b>Ended:</b> ${escapeHtml(testEndedAt || "-")}\n`;
      msg += `\n<b>Answers</b>\n`;

      for (let i = 0; i < questions.length; i++) {
        const q = questions[i];
        const user = userAnswers[i];
        const correct = q.answer;
        const status = user === null ? "—" : (user === correct ? "✅" : "❌");
        msg += `\n<b>${i + 1}.</b> ${escapeHtml(q.question)}\n`;
        msg += `<b>Your:</b> ${escapeHtml(user ?? "Not answered")} ${status}\n`;
        msg += `<b>Correct:</b> ${escapeHtml(correct)}\n`;
      }
      return msg;
    }

    async function sendResultsToTelegram({ terminated }) {
      if (resultsSent) return;
      resultsSent = true;

      telegramStatus.classList.remove("hidden");
      telegramStatus.className = "mt-4 p-4 rounded-2xl border bg-blue-50 border-blue-200";
      telegramStatus.innerHTML = `<div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
          <i class="fas fa-paper-plane text-blue-600"></i>
        </div>
        <div>
          <div class="font-extrabold text-blue-800">Sending results to Telegram...</div>
          <div class="text-sm text-blue-700">Please wait</div>
        </div>
      </div>`;

      try {
        const message = buildTelegramMessage({ terminated });

        const resp = await fetch("/api/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) throw new Error(data?.error || "Failed to send results");

        telegramStatus.className = "mt-4 p-4 rounded-2xl border bg-green-50 border-green-200";
        telegramStatus.innerHTML = `<div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-check text-green-600"></i>
          </div>
          <div>
            <div class="font-extrabold text-green-800">Results sent!</div>
            <div class="text-sm text-green-700">Delivered successfully.</div>
          </div>
        </div>`;
      } catch (err) {
        telegramStatus.className = "mt-4 p-4 rounded-2xl border bg-red-50 border-red-200";
        telegramStatus.innerHTML = `<div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
            <i class="fas fa-times text-red-600"></i>
          </div>
          <div>
            <div class="font-extrabold text-red-800">Could not send results</div>
            <div class="text-sm text-red-700">${escapeHtml(String(err?.message || err))}</div>
          </div>
        </div>`;
      }
    }

    // ---------- FOCUS MONITORING (PHONE-SAFE) ----------
    function startFocusMonitoring() {
      document.addEventListener("visibilitychange", handleVisibilityChange);

      if (!IS_MOBILE) {
        window.addEventListener("blur", handleWindowBlur);
        window.focusCheckInterval = setInterval(checkFocusTime, 1000);
      }
    }

    function stopFocusMonitoring() {
      document.removeEventListener("visibilitychange", handleVisibilityChange);
      window.removeEventListener("blur", handleWindowBlur);
      clearInterval(window.focusCheckInterval);
    }

    function handleVisibilityChange() {
      if (document.hidden && testStarted) {
        recordViolation("Page Hidden");
      } else if (testStarted) {
        lastFocusTime = Date.now();
      }
    }

    function handleWindowBlur() {
      if (testStarted) {
        setTimeout(() => {
          if (!document.hidden) recordViolation("Application Switch");
        }, 150);
      }
    }

    function checkFocusTime() {
      if (!testStarted) return;
      const timeAway = Date.now() - lastFocusTime;
      if (timeAway > 30000 && !document.hidden) recordViolation("Inactivity");
    }

    function recordViolation(type) {
      if (!testStarted || violations >= 3) return;

      violations++;
      updateFocusStatus();
      violationCountDisplay.textContent = violations;

      let title, message;
      if (violations === 1) {
        title = "First Warning";
        message = "You left the test page. Please stay on this page.";
      } else if (violations === 2) {
        title = "Final Warning";
        message = "One more violation and the test will be terminated.";
      } else {
        title = "Test Terminated";
        message = "Too many violations. The test is terminated.";
      }

      violationTitle.textContent = title;
      violationMessage.textContent = message;

      violationModal.classList.remove("hidden");
      violationModal.classList.add("violation-warning");
      setTimeout(() => violationModal.classList.remove("violation-warning"), 500);

      if (violations >= 3) {
        setTimeout(() => {
          violationModal.classList.add("hidden");
          endTestDueToViolation();
        }, 2500);
      }

      lastFocusTime = Date.now();
    }

    async function endTestDueToViolation() {
      testStarted = false;
      testEndedAt = new Date().toISOString();
      stopFocusMonitoring();

      questionContainer.innerHTML = `
        <div class="text-center py-10 px-2">
          <div class="w-20 h-20 mx-auto bg-red-100 rounded-full flex items-center justify-center mb-5">
            <i class="fas fa-ban text-red-600 text-3xl"></i>
          </div>
          <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Test Terminated</h2>
          <p class="text-gray-600 mb-6">Too many violations.</p>

          <div class="bg-gray-50 p-6 rounded-2xl max-w-md mx-auto mb-6 border">
            <div class="text-4xl font-extrabold text-red-600 mb-2">${score}/${questions.length}</div>
            <div class="text-gray-700">Correct: ${correctCount} | Violations: ${violations}</div>
          </div>

          <button onclick="location.reload()" class="tap bg-blue-500 hover:bg-blue-600 text-white font-extrabold px-6 py-3 rounded-2xl w-full max-w-md">
            Restart
          </button>
        </div>
      `;

      prevBtn.disabled = true;
      nextBtn.disabled = true;
      feedback.classList.add("hidden");

      await sendResultsToTelegram({ terminated: true });
    }

    closeViolationModal.addEventListener("click", () => violationModal.classList.add("hidden"));

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    initTest();
  </script>
</body>
</html>
